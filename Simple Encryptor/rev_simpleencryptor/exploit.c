#include <stdio.h>
#include <stdlib.h>
#include <string.h>  // Added this line for memcpy

int main(void) {
    typedef unsigned char byte;
    FILE *f;
    size_t flagSize;
    byte *flag;
    unsigned int seed;
    long i;
    int rnd1, rnd2;

    f = fopen("flag.enc", "rb");
    if (!f) {
        perror("fopen");
        return 1;
    }
    // Seek until the end of the file to get the size
    fseek(f, 0, SEEK_END);
    flagSize = ftell(f);
    // Seek to the beginning
    fseek(f, 0, SEEK_SET);
    // Allocate memory for the flag
    flag = malloc(flagSize);
    if (!flag) {
        perror("malloc");
        fclose(f);
        return 1;
    }
    fread(flag, 1, flagSize, f);
    fclose(f);

    // Take seed from the first 4 bytes
    int flagOffset = 4;
    memcpy(&seed, flag, flagOffset);
    srand(seed);

    for (i = flagOffset; i < (long)flagSize; i++) {
        rnd1 = rand();
        rnd2 = rand() & 7;
        flag[i] = 
            (flag[i] >> rnd2) | 
            (flag[i] << (8 - rnd2));
        flag[i] = rnd1 ^ flag[i];
        printf("%c", flag[i]);
    }

    free(flag);  // Free allocated memory
    return 0;
}
